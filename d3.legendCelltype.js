
(function() {
d3.legendCelltype = function(g) {
  g.each(function() {
    var g= d3.select(this),
        items = {},
        svg = d3.select(g.property("nearestViewportElement")),
        legendPadding = g.attr("data-style-padding") || 5,
        //lb = g.selectAll(".legend-box").data([true]),
        li = g.selectAll(".legend-items").data([true])

    //lb.enter().append("rect").classed("legend-box",true)
    li.enter().append("g").classed("legend-items",true)

    svg.selectAll("[data-legendCelltype]").each(function() {
        var self = d3.select(this)
        items[self.attr("data-legendCelltype")] = {
          pos : self.attr("data-legend-pos") || this.getBBox().y,
          color : self.attr("data-legend-color") != undefined ? self.attr("data-legend-color") : self.style("fill") != 'none' ? self.style("fill") : self.style("stroke") 
        }
      })

    items = d3.entries(items).sort(function(a,b) { return a.value.pos-b.value.pos})

    let myMap_3 = new Map()
      myMap_3.set("1", "Roof plate")
      myMap_3.set("2", "Neural crest (PNS glia)")
      myMap_3.set("3", "Mesencephalon/MHB")
      myMap_3.set("4", "Di/telencephalon B")
      myMap_3.set("5", "Di/telencephalon A")
      myMap_3.set("6", "Retinal neurons")
      myMap_3.set("7", "Retinal pigment cells")
      myMap_3.set("8", "Retinal primordium")
      myMap_3.set("9", "Forebrain/midbrain")
      myMap_3.set("10", "Neural crest (PNS neurons)")
      myMap_3.set("11", "Olfactory sensory neurons")
      myMap_3.set("12", "Noradrenergic neurons")
      myMap_3.set("13", "Motor neurons")
      myMap_3.set("14", "Intermediate progenitor cells")
      myMap_3.set("15", "Inhibitory interneurons")
      myMap_3.set("16", "Inhibitory neurons")
      myMap_3.set("17", "Inhibitory neuron progenitors")
      myMap_3.set("18", "Excitatory neurons")
      myMap_3.set("19", "Excitatory neuron progenitors")
      myMap_3.set("20", "Neuron progenitor cells")
      myMap_3.set("21", "Floor plate")
      myMap_3.set("22", "Hindbrain")
      myMap_3.set("23", "Spinal cord (dorsal)")
      myMap_3.set("24", "Rostral neuroectoderm")
      myMap_3.set("25", "Epiblast")
      myMap_3.set("26", "Spinal cord (ventral)")
      myMap_3.set("27", "Oligodendrocyte precursor")
      myMap_3.set("28", "Caudal neuroectoderm")
      myMap_3.set("29", "Neuromesodermal progenitors")
      myMap_3.set("30", "Caudal lateral epiblast")
      myMap_3.set("31", "Otic epithelium")
      myMap_3.set("32", "Olfactory epithelium")
      myMap_3.set("33", "Retinal epithelium")
      myMap_3.set("34", "Branchial arch epithelium")
      myMap_3.set("35", "Placodal area")
      myMap_3.set("36", "Fusing epithelium")
      myMap_3.set("37", "Epidermis")
      myMap_3.set("38", "Pre-epidermal keratinocytes")
      myMap_3.set("39", "Renal epithelium")
      myMap_3.set("40", "Surface ectoderm")
      myMap_3.set("41", "Primitive streak & adjacent ectoderm")
      myMap_3.set("42", "Primordial germ cells")
      myMap_3.set("43", "Anterior primitive streak")
      myMap_3.set("44", "Gut & lung epithelium")
      myMap_3.set("45", "Hepatocytes")
      myMap_3.set("46", "Gut")
      myMap_3.set("47", "Definitive endoderm")
      myMap_3.set("48", "Notochord")
      myMap_3.set("49", "Osteoblast progenitors A")
      myMap_3.set("50", "Osteoblast progenitors B")
      myMap_3.set("51", "Myocytes")
      myMap_3.set("52", "Skeletal muscle progenitors")
      myMap_3.set("53", "Early chondrocytes")
      myMap_3.set("54", "Chondrocyte & osteoblast progenitors")
      myMap_3.set("55", "Connective tissue progenitors")
      myMap_3.set("56", "Paraxial mesoderm A")
      myMap_3.set("57", "Stromal cells")
      myMap_3.set("58", "Paraxial mesoderm B")
      myMap_3.set("59", "Paraxial mesoderm C")
      myMap_3.set("60", "Nascent mesoderm")
      myMap_3.set("61", "Limb mesenchyme progenitors")
      myMap_3.set("62", "Intermediate mesoderm")
      myMap_3.set("63", "Splanchnic mesoderm")
      myMap_3.set("64", "Cardiomyocytes")
      myMap_3.set("65", "Somatic mesoderm A")
      myMap_3.set("66", "Somatic mesoderm B")
      myMap_3.set("67", "Somatic mesoderm")
      myMap_3.set("68", "Extraembryonic mesoderm")
      myMap_3.set("69", "Allantois")
      myMap_3.set("70", "Mixed mesoderm")
      myMap_3.set("71", "Endothelium")
      myMap_3.set("72", "Hematoendothelial progenitors")
      myMap_3.set("73", "Blood progenitors")
      myMap_3.set("74", "White blood cells")
      myMap_3.set("75", "Megakaryocytes")
      myMap_3.set("76", "Definitive erythroid cells")
      myMap_3.set("77", "Primitive erythroid cells")
      myMap_3.set("78", "Embryonic visceral endoderm")
      myMap_3.set("79", "Extraembryonic visceral endoderm")
      myMap_3.set("80", "Visceral endoderm")
      myMap_3.set("81", "Parietal endoderm")
      myMap_3.set("82", "Hypoblast")
      myMap_3.set("83", "Inner cell mass")
      myMap_3.set("84", "Morula")
      myMap_3.set("85", "Trophectoderm")
      myMap_3.set("86", "Extraembryonic ectoderm")

    li.selectAll("text")
        .data(items,function(d) { return d.key})
        .call(function(d) { d.enter().append("text")})
        .call(function(d) { d.exit().remove()})
        .attr("y",function(d,i) { return i*1.501+"em"})
        .attr("x","1em")
        //.text(function(d) { return d.key})
        .text(function(d) { return myMap_3.get(d.key)})
    
  
    
    // Reposition and resize the box
   // var lbbox = li[0][0].getBBox()  
    //lb.attr("x",(lbbox.x-legendPadding))
    //    .attr("y",(lbbox.y-legendPadding))
    //    .attr("height",(lbbox.height+2*legendPadding))
     //   .attr("width",(lbbox.width+2*legendPadding))
  })
  return g
}
})()