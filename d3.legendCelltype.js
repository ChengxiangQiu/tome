
(function() {
d3.legendCelltype = function(g) {
  g.each(function() {
    var g= d3.select(this),
        items = {},
        svg = d3.select(g.property("nearestViewportElement")),
        legendPadding = g.attr("data-style-padding") || 5,
        //lb = g.selectAll(".legend-box").data([true]),
        li = g.selectAll(".legend-items").data([true])

    //lb.enter().append("rect").classed("legend-box",true)
    li.enter().append("g").classed("legend-items",true)

    svg.selectAll("[data-legendCelltype]").each(function() {
        var self = d3.select(this)
        items[self.attr("data-legendCelltype")] = {
          pos : self.attr("data-legend-pos") || this.getBBox().y,
          color : self.attr("data-legend-color") != undefined ? self.attr("data-legend-color") : self.style("fill") != 'none' ? self.style("fill") : self.style("stroke") 
        }
      })

    items = d3.entries(items).sort(function(a,b) { return a.value.pos-b.value.pos})

    let myMap_3 = new Map()
      myMap_3.set("1", "Ependymal cell")
      myMap_3.set("2", "Neural crest")
      myMap_3.set("3", "Isthmic organizer cells")
      myMap_3.set("4", "Wnt8b positive cell")
      myMap_3.set("5", "Wnt8b positive cell prog.")
      myMap_3.set("6", "Retina neuron")
      myMap_3.set("7", "Retina pigment cells")
      myMap_3.set("8", "Retina primordium")
      myMap_3.set("9", "Forebrain/Midbrain")
      myMap_3.set("10", "Sensory neuron")
      myMap_3.set("11", "Olfactory sensory neuron")
      myMap_3.set("12", "Small sensory neuron")
      myMap_3.set("13", "Cholinergic neurons")
      myMap_3.set("14", "Granule neurons")
      myMap_3.set("15", "Inhibitory interneurons")
      myMap_3.set("16", "Inhibitory neurons")
      myMap_3.set("17", "Inhibitory neuron prog.")
      myMap_3.set("18", "Excitatory neurons")
      myMap_3.set("19", "Postmitotic premature neuron")
      myMap_3.set("20", "Neuron prog.")
      myMap_3.set("21", "Notoplate")
      myMap_3.set("22", "Hindbrain")
      myMap_3.set("23", "Radial glia")
      myMap_3.set("24", "Rostral neurectoderm")
      myMap_3.set("25", "Epiblast")
      myMap_3.set("26", "Spinal cord")
      myMap_3.set("27", "Oligodendrocyte precursor")
      myMap_3.set("28", "Caudal neurectoderm")
      myMap_3.set("29", "NMP")
      myMap_3.set("30", "Caudal lateral epiblast")
      myMap_3.set("31", "Otic epithelium")
      myMap_3.set("32", "Olfactory epithelium")
      myMap_3.set("33", "Retina epithelium")
      myMap_3.set("34", "Branchial arch epithelium")
      myMap_3.set("35", "Placodal area")
      myMap_3.set("36", "Keratinized epithelium")
      myMap_3.set("37", "Squamous epithelium")
      myMap_3.set("38", "Epidermis")
      myMap_3.set("39", "Renal epithelium")
      myMap_3.set("40", "Surface ectoderm")
      myMap_3.set("41", "Primitive Streak")
      myMap_3.set("42", "PGC")
      myMap_3.set("43", "Anterior Primitive Streak")
      myMap_3.set("44", "Fore/Mid/Hindgut epithelium")
      myMap_3.set("45", "Hepatocytes")
      myMap_3.set("46", "Gut")
      myMap_3.set("47", "Def. endoderm")
      myMap_3.set("48", "Notochord")
      myMap_3.set("49", "Osteoblast prog. A")
      myMap_3.set("50", "Osteoblast prog. B")
      myMap_3.set("51", "Myocytes")
      myMap_3.set("52", "Skeletal muscle prog.")
      myMap_3.set("53", "Early chondrocyte")
      myMap_3.set("54", "Chondrocyte prog.")
      myMap_3.set("55", "Connective tissue prog.")
      myMap_3.set("56", "Paraxial mesoderm A")
      myMap_3.set("57", "Stromal cells")
      myMap_3.set("58", "Paraxial mesoderm B")
      myMap_3.set("59", "Paraxial mesoderm C")
      myMap_3.set("60", "Nascent mesoderm")
      myMap_3.set("61", "Limb mesenchyme prog.")
      myMap_3.set("62", "Intermediate mesoderm")
      myMap_3.set("63", "Splanchnic mesoderm")
      myMap_3.set("64", "Cardiomyocytes")
      myMap_3.set("65", "Somatic mesoderm A")
      myMap_3.set("66", "Somatic mesoderm B")
      myMap_3.set("67", "Somatic mesoderm")
      myMap_3.set("68", "ExE mesoderm")
      myMap_3.set("69", "Allantois")
      myMap_3.set("70", "Mixed mesoderm")
      myMap_3.set("71", "Endothelium")
      myMap_3.set("72", "Haematoendothelial prog.")
      myMap_3.set("73", "Blood progenitors")
      myMap_3.set("74", "White blood cells")
      myMap_3.set("75", "Megakaryocytes")
      myMap_3.set("76", "Def. erythrocyte")
      myMap_3.set("77", "Primitive erythroid")
      myMap_3.set("78", "EmVE")
      myMap_3.set("79", "ExVE")
      myMap_3.set("80", "Visceral endoderm")
      myMap_3.set("81", "Parietal endoderm")
      myMap_3.set("82", "Hypoblast")
      myMap_3.set("83", "ICM")
      myMap_3.set("84", "Morula")
      myMap_3.set("85", "Trophectoderm")
      myMap_3.set("86", "ExE ectoderm")

    li.selectAll("text")
        .data(items,function(d) { return d.key})
        .call(function(d) { d.enter().append("text")})
        .call(function(d) { d.exit().remove()})
        .attr("y",function(d,i) { return i*1.501+"em"})
        .attr("x","1em")
        //.text(function(d) { return d.key})
        .text(function(d) { return myMap_3.get(d.key)})
    
  
    
    // Reposition and resize the box
   // var lbbox = li[0][0].getBBox()  
    //lb.attr("x",(lbbox.x-legendPadding))
    //    .attr("y",(lbbox.y-legendPadding))
    //    .attr("height",(lbbox.height+2*legendPadding))
     //   .attr("width",(lbbox.width+2*legendPadding))
  })
  return g
}
})()